{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Activity Logs{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item active">Activity Logs</span>
{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1 class="page-title">Activity Logs</h1>
        <p class="page-description">Track all database operations and changes</p>
    </div>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary" onclick="exportLogs()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Clear Filters
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-6">
    <div class="card-body" style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
            <label class="form-label">Action Type</label>
            <select class="form-select" id="filterAction" onchange="applyFilters()">
                <option value="">All Actions</option>
                <option value="INSERT_ROW">Insert Row</option>
                <option value="UPDATE_ROW">Update Row</option>
                <option value="DELETE_ROW">Delete Row</option>
                <option value="CREATE_TABLE">Create Table</option>
                <option value="DELETE_TABLE">Delete Table</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
            <label class="form-label">Table</label>
            <select class="form-select" id="filterTable" onchange="applyFilters()">
                <option value="">All Tables</option>
                <!-- Populated dynamically -->
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; min-width: 150px;">
            <label class="form-label">Date Range</label>
            <select class="form-select" id="filterDate" onchange="applyFilters()">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">Last 7 Days</option>
                <option value="month">Last 30 Days</option>
            </select>
        </div>
        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
            <label class="form-label">Search</label>
            <input type="text" class="form-input" id="filterSearch" placeholder="Search logs..." oninput="debounceSearch()">
        </div>
    </div>
</div>

<!-- Activity List -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <span id="logsCount">-</span> Events
        </h3>
        <div style="display: flex; gap: 8px;">
            <select class="form-select" style="width: auto; padding: 6px 32px 6px 12px;" id="pageSize" onchange="applyFilters()">
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>
    <div class="card-body" id="activityContainer" style="padding: 0;">
        <!-- Activity items loaded dynamically -->
        <div style="padding: 20px;">
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text medium" style="margin-top: 8px;"></div>
            <div class="skeleton skeleton-text short" style="margin-top: 8px;"></div>
        </div>
    </div>
    <div class="table-pagination" id="logsPagination">
        <div class="pagination-info">Loading...</div>
        <div class="pagination-controls"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let searchDebounce = null;

document.addEventListener('DOMContentLoaded', async () => {
    // Load tables for filter
    try {
        const tables = await API.getTables();
        const filterTable = document.getElementById('filterTable');
        tables.forEach(table => {
            const option = document.createElement('option');
            option.value = table.name;
            option.textContent = table.name;
            filterTable.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load tables:', error);
    }

    // Load activity logs
    loadLogs();
});

async function loadLogs(page = 1) {
    currentPage = page;
    const container = document.getElementById('activityContainer');
    
    // Show loading
    container.innerHTML = `
        <div style="padding: 20px;">
            <div class="skeleton skeleton-text"></div>
            <div class="skeleton skeleton-text medium" style="margin-top: 8px;"></div>
            <div class="skeleton skeleton-text short" style="margin-top: 8px;"></div>
        </div>
    `;

    try {
        const params = {
            page: page,
            limit: document.getElementById('pageSize').value,
        };

        const action = document.getElementById('filterAction').value;
        if (action) params.action = action;

        const table = document.getElementById('filterTable').value;
        if (table) params.table = table;

        const dateRange = document.getElementById('filterDate').value;
        if (dateRange) params.date_range = dateRange;

        const search = document.getElementById('filterSearch').value;
        if (search) params.search = search;

        const data = await API.getActivityLogs(params);
        renderLogs(data);
    } catch (error) {
        console.error('Failed to load logs:', error);
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px;">
                <p class="text-muted">Failed to load activity logs</p>
                <button class="btn btn-primary btn-sm mt-4" onclick="loadLogs()">Retry</button>
            </div>
        `;
    }
}

function renderLogs(data) {
    const container = document.getElementById('activityContainer');
    const logs = data.logs || [];

    document.getElementById('logsCount').textContent = data.total || 0;

    if (logs.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 60px;">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                </div>
                <h3 class="empty-title">No Activity Found</h3>
                <p class="empty-description">There are no activity logs matching your filters.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="activity-list" style="padding: 0;">
            ${logs.map(log => `
                <div class="activity-item" style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">
                    <div class="activity-icon ${log.action}">
                        ${getActivityIcon(log.action)}
                    </div>
                    <div class="activity-content" style="flex: 1;">
                        <div class="activity-title">${formatActivityTitle(log)}</div>
                        <div class="activity-time">${log.time_ago || formatTimestamp(log.created_at)}</div>
                    </div>
                    <div style="text-align: right;">
                        <span class="schema-badge ${log.action}">${formatActionBadge(log.action)}</span>
                        ${log.ip_address ? `<div class="text-muted" style="font-size: 11px; margin-top: 4px;">IP: ${UI.escapeHtml(log.ip_address)}</div>` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;

    // Render pagination
    renderPagination(data.total, data.page, data.page_size);
}

function renderPagination(total, page, pageSize) {
    const pagination = document.getElementById('logsPagination');
    const totalPages = Math.ceil(total / pageSize);
    const start = (page - 1) * pageSize + 1;
    const end = Math.min(page * pageSize, total);

    let pagesHtml = '';
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= page - 1 && i <= page + 1)) {
            pagesHtml += `
                <button class="pagination-btn ${i === page ? 'active' : ''}" onclick="loadLogs(${i})">
                    ${i}
                </button>
            `;
        } else if (i === page - 2 || i === page + 2) {
            pagesHtml += `<span style="padding: 0 4px;">...</span>`;
        }
    }

    pagination.innerHTML = `
        <div class="pagination-info">
            Showing ${total > 0 ? start : 0} to ${end} of ${total} events
        </div>
        <div class="pagination-controls">
            <button class="pagination-btn" onclick="loadLogs(${page - 1})" ${page <= 1 ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            ${pagesHtml}
            <button class="pagination-btn" onclick="loadLogs(${page + 1})" ${page >= totalPages ? 'disabled' : ''}>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
    `;
}

function getActivityIcon(action) {
    const icons = {
        'INSERT_ROW': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',
        'UPDATE_ROW': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
        'DELETE_ROW': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
        'CREATE_TABLE': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM3 9h18"></path></svg>',
        'DELETE_TABLE': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18v18H3zM3 9h18"></path><line x1="9" y1="14" x2="15" y2="14" stroke="red"></line></svg>',
    };
    return icons[action] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg>';
}

function formatActivityTitle(log) {
    const actions = {
        'INSERT_ROW': 'Row inserted into',
        'UPDATE_ROW': 'Row updated in',
        'DELETE_ROW': 'Row deleted from',
        'CREATE_TABLE': 'Table created:',
        'DELETE_TABLE': 'Table deleted:',
    };
    let title = `${actions[log.action] || 'Action on'} <strong>${UI.escapeHtml(log.table_name)}</strong>`;
    if (log.metadata && log.metadata.row_id) {
        title += ` <span class="text-muted">(Row ID: ${log.metadata.row_id})</span>`;
    }
    return title;
}

function formatActionBadge(action) {
    const labels = {
        'INSERT_ROW': 'INSERT',
        'UPDATE_ROW': 'UPDATE',
        'DELETE_ROW': 'DELETE',
        'CREATE_TABLE': 'CREATE',
        'DELETE_TABLE': 'DROP',
    };
    return labels[action] || action;
}

function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    });
}

function applyFilters() {
    loadLogs(1);
}

function debounceSearch() {
    clearTimeout(searchDebounce);
    searchDebounce = setTimeout(() => applyFilters(), 300);
}

function clearFilters() {
    document.getElementById('filterAction').value = '';
    document.getElementById('filterTable').value = '';
    document.getElementById('filterDate').value = '';
    document.getElementById('filterSearch').value = '';
    loadLogs(1);
}

function exportLogs() {
    UI.showToast('Export feature coming soon', 'warning');
}
</script>
{% endblock %}
